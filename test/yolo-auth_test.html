<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>yolo-auth test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../yolo-auth.html">
  </head>
  <body>

    <test-fixture id="InstantiationTestFixture">
      <template>
        <yolo-auth></yolo-auth>
      </template>
    </test-fixture>

    <test-fixture id="ApiCheckFixture">
      <template>
        <yolo-auth></yolo-auth>
      </template>
    </test-fixture>

    <script>
      const stubUserInfo = {
        authMethod: 'https://accounts.google.com',
        displayName: 'Foo Bar',
        id: 'foo@gmail.com',
        idToken: 'shfjkshfheufhjdfkajsfnuihunj',
        profilePicture: 'https://usercontent/foo/image.jpg'
      };

      const stubGoogleYolo = {
        retrieve: (reqObj) => {
          return new Promise((resolve, reject) => {
            const p = Math.random();
            if (p > 0.5) {
              resolve(stubUserInfo);
            } else {
              reject({type: 'noCredentialsAvailable'});
            }
          });
        },
        hint: (reqObj) => {
          return new Promise((resolve, reject) => {
            resolve(stubUserInfo);
          });
        },
        cancelLastOperation: () => {
          return new Promise((resolve, reject) => {
            resolve();
          });
        }
      };

      const stubScript = () => {
        window.googleyolo = stubGoogleYolo;
      };

      suite('yolo-auth', () => {

        test('instantiating the element with default properties', () => {
          const element = fixture('InstantiationTestFixture');
          assert.equal(element.clientId, undefined);
          assert.equal(element.user, undefined);
        });

        test('checking the element has correct public API', () => {
          const element = fixture('ApiCheckFixture');
          stubScript();

          const signIn = element.signIn;
          const signInResp = signIn.bind(element).call();
          assert.isFunction(signIn);
          assert.instanceOf(signInResp, Promise);

          const cancelOp = element.cancelOperation;
          const cancelOpResp = cancelOp.bind(element).call();
          assert.isFunction(cancelOp);
          assert.instanceOf(cancelOpResp, Promise);
        });

        test('checking signIn method works', async () => {
          const element = fixture('ApiCheckFixture');
          stubScript();

          const result = await element.signIn();
          assert.equal(result, stubUserInfo);
        });

        test('checking cancelOperation method works', async () => {
          const element = fixture('ApiCheckFixture');
          stubScript();

          await element.cancelOperation();
          assert.isOk(true);
        });
      });
    </script>

  </body>
</html>
